---
layout: base
title: Guide
---
<h2>Database introspection</h2>

<p>Database introspection refers to the means of retrieving database schema meta-data : table names, columns names, column types and indexes.</p>

<p>Table data is stored in instances of the <span class="inline_code">\Glue\DB\Table</span> class. These objects can be retrieved like this :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;
  
  // Returns data about table 'mytable' of connection 'myconnection'
  $table = DB::cn('myconnection')->table('mytable');
  
?>
{% endhighlight %}

<p>Column data is stored in instances of the <span class="inline_code">\Glue\DB\Column</span></p> class. These objects can be retrieved like this :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;
  
  // Returns data about column 'mycolumn' of table 'mytable' of connection 'myconnection'
  $column = DB::cn('myconnection')->table('mytable')->column('mycolumn');
  
  // Available data about that column :
  $name       = $column->name();        // Name
  $type       = $column->type()));      // Database type (as returned by RDBMS)
  $phptype    = $column->phptype());    // Most appropriate PHP type to store column data    
  $nullable   = $column->nullable());   // Whether or not column is nullable
  $maxlength  = $column->maxlength());  // Max length for character columns
  $precision  = $column->precision());  // Decimal(6,2) ? => precision = 6
  $scale      = $column->scale());      // Decimal(6,2) ? => scale = 2
  $default    = $column->default());    // Default column value (type casted according to php type)
  $auto       = $column->auto());       // Whether or not column is auto-incrementing
?>
{% endhighlight %}

<p>It is also possible to list all tables on a connection, and all columns of a table :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;

  // Display tables of default connection :
  foreach(DB::cn()->tables() as $table) {
    // Display table name :
    echo $table->name() . '<br/>';
    
    // Display columns of current table :
    foreach($table->columns() as $column) {
      // Display column name :
      echo '&nbsp;&nbsp;' . $column->name() . '<br/>';
    }
  }
?>
{% endhighlight %}

<p>All of these columns and tables objects behave as singletons. They are created upon first request and then reused. That is :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;
  
  $t1 = DB::cn()->table('mytable');
  $t2 = DB::cn()->table('mytable');
  
  var_dump($t1 === $t2); // TRUE
?>
{% endhighlight %}

<p>All introspected data is cached on disk as serialized <span class="inline_code">\Glue\DB\Table</span> objects. If you change the database schema, you must clear the cache by deleting the cache directory. If not in production, you may also disable the introspection cache entirely (see options).</p>

<h2>Aliasing system</h2>

<p>By default, tables and columns are known to the application by the same names that they have in whatever database they are stored into :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;
  
  // Returns data about the column 'mycolumn' of the database table 'mytable'
  $col_data = DB::table('mytable')->column('mycolumn');
  
  // Returns "SELECT `mytable`.`mycolumn` FROM `mytable`"
  $sql = DB::select('mytable', $m)->columns($m->mycolumn)->root()->sql();
  
?>
{% endhighlight %}

<p>However, aliases may be defined. If you do so, each time you refer to <span class="inline_code">mytable</span> and <span class="inline_code">mycolumn</span>, the library knows that you actually mean for example <span class="inline_code">anothertable</span> and <span class="inline_code">anothercolumn</span> :</p>

{% highlight php %}
<?php
  
  use Glue\DB\DB;
  
  // Now returns data about the column 'anothercolumn' of the table 'anothertable'
  $col_data = DB::table('mytable')->column('mycolumn');
  
  // Now returns "SELECT `anothertable`.`anothercolumn` FROM `anothertable`"
  $sql = DB::select('mytable', $m)->columns($m->mycolumn)->root()->sql();
  
?>
{% endhighlight %}

<p>Setting up aliases is done by defining your own virtual tables.</p>

<h2>Virtual tables</h2>

<p>Table names in the introspection API or in the query builder don't actually refer to a database tables. They refer to PHP objects called virtual tables.</p>

<p> To set up such aliases, you must define a virtual table. Table aliases are defined by extending the ~\Glue\DB\Table class. The class name defines the table alias. The real table name my be defined by overriding the <span class="inline_code">$dbtable</span> property declaration. Column aliases may be defined by overriding the function <span class="inline_code">string get_column_alias(\Glue\DB\Column $column)</span> :</p>

{% highlight php %}
<?php
  // File classes/user/db/foo/bar.php
  
  namespace Glue\User\DB;
  
  class Table_Anothertable extends \Glue\DB\Table {
    
    // Override real table name :
    protected $dbtable = 'mytable';
    
    // Override column alias for mycolumn :
    public function get_column_alias(\Glue\DB\Column $column) {
      if ($column->dbname() === 'mycolumn')
        return 'anothercolumn';
      return parent::get_column_alias($column);
    }
  }
?>
{% endhighlight %}

<p>The introspection API and the query builder will now reflect those changes :</p>













